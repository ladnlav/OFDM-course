# Отчет к домашнему заданию №2: Рандомизатор и расчёт PAPR

## Квинтэссенция работы
Эта работа представляет собой небольшую модернизацию базовой модели OFDM-передатчика и приёмника (рисунок 1). Был добавлен рандомизатор (скрэмблер) и соответственно дерандомизатор (дескрэмблер) в целях уменьшения PAPR. Также добавлены функции расчёта PAPR по OFDM-символам, а также функции построения CCDF. 
![Alt-text](<graphs/task2.png>)

_Рисунок №1. Пайплайн OFDM-системы_

## Что такое PAPR?
![Alt-text](<graphs/paprformula.png>)

_Рисунок №2. Формула для расчёта PAPR_

__PAPR (peak-to-average power ratio)__ - пик фактор или отношение пиков мощности OFDM-сигнала к среднему значению мощности. Оценка PAPR (рассчитывается по формуле на рисунке 2) полезна тем, что позволяет численно характеризовать явление, когда внутри одного OFDM-символа наблюдаются резкие всплески сигнала по амплитуде из-за того, что передаются сразу несколько частот (синусоид), которые при наложении друг на друга могут дать резкое усиление в амплитуде. И нам важно следить за высоким PAPR, ибо так или иначе наш сигнал будет проходить через усилитель, который имеет свою характеристику усиления (рисунок 3). И тут возможно два варианта:
* либо мы к средней мощности сигнала прибавляем мощность пиков, из-за чего пики усиливаются сильно, а другие отсчёты сигнала слабо (с инженерной точки зрения это плохо тем, что происходит неэффективное использование усилителя - большая часть энергии будет тратиться на усиление редких пиков, в то время как основная часть будет усиливаться слабо, кроме того это повышает требования к самому усилителю, ведь теперь нужен усилитель с большим динамическим диапазоном, что усложняет и удорожает всю схему);
* либо мы делаем так, что средняя мощность сосредоточена в окрестности точки В, для того чтоб основные отсчёты сигнала усиливались в окрестности точки B - это приведёт к тому, что некоторые точки с изначально высокой мощностью будут выбиваться в нелинейную область C, почему будет происходить обрезание по мощности (клиппирование) и потеря информации. 

Поэтому важно, чтоб PAPR не превышал определённого уровня. Иначе в реальной системе связи получаем такие негативные эффекты, как клиппирование, проявление внеполосового излучения и, как следствие, снижение качества передачи.

![Alt-text](<graphs/amp.png>)

_Рисунок №3. Характеристика усилителя_

## Что такое CCDF(PAPR)?
__CCDF (PAPR)__ - это комплементарные интегральные функции распределения (CCDF -complementary-cumulative-distribution-
function) пик-фактора (рисунок 4). Эта функция говорит нам о вероятности того, что пик-фактор OFDM-символа превышает данный уровень PAPR. 

CCDF лучше простого PAPR тем, что даёт нам некоторое представление о том, в каком количестве резкие пики присутствуют в сигнале и можно ли их игнорировать (к примеру, если у нас большие значения PAPR имеют очень маленькую вероятность появления, то мы можем с ними смириться и ничего не предпринимать для уменьшения значений PAPR). Но в то же время недостаток этого способа оценки пик-фактора заключается в необходимости проведения расчета PAPR с помощью скользящего окна по всему OFDM-сигналу, что усложняет вычисления.
![Alt-text](<graphs/ССDF.png>)

_Рисунок №4. Пример CCDF-кривых_

## PAPR сигнала с рандомизацией vs PAPR обычного сигнала
### Процесс рандомизации
Рандомизация производится на основе РСЛОС (регистр сдвига с линейной обратной связью). Схема рандомизации представлена на рисунке 5. Т.е. мы проходим операцией `xor` по регистру состояния, учитывая заранее заданные коэффициенты, далее результат этого прохода мы запоминаем как `feedback` и потом циклически сдвигаем регистр, заменяя 1 бит этим значением. Далее `feedback` ещё раз подаём на вход функции `xor`, но уже вместе с входным потоком бит. И так на выходе получается рандомизированный поток бит.
![Alt-text](<graphs/rslos.png>)

_Рисунок №5. Схема рандомизации битового потока на основе РСЛОС_

**Параметры скрамблера**
* Начальное состояние регистра: `Register = [1 0 0 1 0 1 0 1 0 0 0 0 0 0 0]`;
* Маска коэффициентов: `coeff_mask=[1 0 0 0 0 0 0 0 0 0 0 0 0 1 1]`

Для системы рандомизатор нужен для того, чтобы уменьшить вероятность того, что у нас одна синусоида накладывается на другую, засчет чего появляютя резкие пики в сигнале. Другими словами, рандомизатор уменьшает коррелированность входного потока бит (коррелированный поток бит в контексте сигнальных созвездий означает, что у нас точки сигнала неравномерно распределяются между всеми точками сигнального созвездия, а с существенными перекосами по количеству в сторону определённых точек созвездия). Однако это плохо тем, что мы не можем извлечь информацию из принятого сигнала сразу же, т.е. нам необходимо произвести дерандомизацию. Т.е. наша система связи усложняется из-за добавления блоков рандомизации - дерандомизации.

### Результат сравнения
В данном случае PAPR рассчитывался по формуле, указанной на рисунке 2. 1 значение на весь сигнал из 50 ofdm-символов.   

* PAPR обычного и рандомизированного сигналов
![Alt-text](<graphs/PAPR1.png>)

_Рисунок №6. Пример работы программного кода_

Как видно из работы кода (рисунок 6), при рандомизации значение PAPR `23 dB`, а без неё `10 dB` - PAPR с рандомизацией лучше. На мой взгляд, отличие связано с тем, что поскольку передаётся картинка, то мы имеем коррелированный поток бит, из-за чего при OFDM-модуляции некоторые синусоиды складываются и дают ощутимые пики во временной области, а когда мы рандомизируем наш битовый поток, мы убираем коррелированность в данных, поэтому пики перестают иметь такие большие значения, как имели до.

## CCDF(PAPR) сигнала с рандомизацией vs CCDF(PAPR) обычного сигнала
В данном случае PAPR рассчитывался по формуле, указанной на рисунке 2, но теперь использовалось скользящее окно размером в `Nfft = 1024` отсчёта, со сдвигом в `1 отсчёт`, опять же для 50 ofdm-символов. CCDF же рассчитывалась по полученным значениям оконного PAPR по формуле, представленной на рисунке 7.

![Alt-text](<graphs/ССDF_t.png>)

_Рисунок №7. Формула CCDF_


__CCDF(PAPR) для обычного и рандомизированного сигналов__
![Alt-text](<graphs/ССDF2.png>)

_Рисунок №8. CCDF обычного сигнала и рандомизированного сигнала_

**Отличия**. Говоря о конкретных значениях (рисунок 8), можно выделить следующее: 
* Пик-фактор рандомизирванного сигнала с вероятностью в `0,02` превышает значение примерно 10 dB;
* Пик-фактор обычного сигнала с вероятностью в `0,02` превышает значение примерно 22 dB.

Качественное сравнение:
 Во-первых, CCDF рандомизированного сигнала находится слева относительно CCDF обычного сигнала - значения PAPR  с рандомизатором в целом ниже. Во-вторых, наблюдается более резкий спад CCDF в рандомизированном случае - это говорит о том, что различных значений PAPR в рандомизированном OFDM-сигнале в целом меньше, если сравнивать с обычным OFDM-сигналом.

**Лучший сценарий.** Очевидно, лучшим сценарием является использование рандомизированного OFDM-сигнала, потому что PAPR в целом меньше и мощность пиков ближе к средней мощности сигнала.

**Причина различий в PAPR.** Как уже отмечалось выше, рандомизация убирает коррелированность передаваемого потока бит, что в свою очередь уменьшает возможные пики из-за наложения синусоид.