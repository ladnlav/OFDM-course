# Отчет к домашнему заданию №4: Синхронизация. Компенсация канальных искажений

## Квинтэссенция работы
 В этой работе рассмотрены способы компенсации различных канальных искажений (АБГШ, временной рассинхронизации, частотной рассинхронизации и многолучевого распространения). Для этого были использованы такие инструменты, как корреляционный анализ, расчёт дифференциальных коэффициентов, оценка канальной характеристики и эквализация. В целях оценки канала в сигнал встраиваются пилоты. Схему построенной в этой работе системы можно видеть на рисунке №1.

![Alt-text](<graphs/task4.png>)

_Рисунок №1. Пайплайн OFDM-системы_

**Параметры OFDM передачи**
* Сигнальное созвездие: `16QAM`;
* Длительной полезной части в количестве fft отсчётов: `N_fft = 1024`
* Количество поднесущих в одном OFDM символе: `N_carrier = 400`
* Длина защитного интервала: `T_Guard = Nfft/8=128`
* Количество кадров: `Amount_OFDM_Frames = 10`
* Количество генерируемых OFDM символов: `Amount_OFDM_Symbols_per_Frame = 5`
* Количество пилотных поднесущих (процент от полосы):
`Percent_pilot = 15`
* Амплитуда пилотных значений:
`4/3*максимальная_амплитуда_созвездия`

## Пилот сигнал
Pilot Carriers - это поднесущие, которые содержат в себе известные значения для осуществления оценки канала и эквалайзинга на приемнике. Пилоты встраиваются в сигнал вместе с данными на этапе формирования полосы сигнала. Они обеспечивают контрольные точки для определения канальной характеристики и её компенсации. Однако за это мы платим пропускной способностью, ведь эти пилоты занимают часть полезных поднесущих, на которых можно было бы передавать данные. АЧХ полезной части одного ofdm-символа и сигнальное созвездие после встраивания пилотов можно наблюдать на рисунках 2 и 3.

В данной реализации амплитуда пилотов составляет $\frac{4}{3}$ от максимальной амплитуды созвездия. Фазы пилотов задаются чередованием фаз BPSK модуляции `(0, pi)`. Пилоты равномерно распределены по полосе, первая и последняя поднесущая тоже отнесены к пилотным.

![Alt-text](<graphs/achx_pilots.png>)

_Рисунок №2. АЧХ полезной части ofdm-символа с пилотами_

![Alt-text](<graphs/sig_pilots.png>)

_Рисунок №3. Сигнальное созвездие с пилотами_

## Грубая временная синхронизация
### Защитный интервал

![Alt-text](<graphs/GI.png>)

_Рисунок №4. Схема добавления защитного интервала по принципу циклического префикса_

Защитный интервал: это часть сигнала, входящая в состав OFDM-символа для сохранения 
возможности демодуляции OFDM-сигнала в присутствии многолучевых помех, таких как отражения 
сигнала и разные задержки лучей этого сигнала. Защитный интервал обеспечивает ортогональность 
между полезными частями символов, позволяя правильно разделять их в приемнике. То есть защитный интервал служит 
неким окном, в течение которого символы разных лучей могут интерферировать между собой, но уже 
в полезной части символа (на рисунке №4 - T_useful) гарантируется отсутствие этой интерференции. 
Второстепенное назначение защитного интервала заключается в том, что:
1. с его наличием становится возможным считать циклическую свёртку ofdm-символа.
2. его можно использовать в алгоритмах синхронизации для компенсации временной и частотной рассинхронизаций.

В данной работе защитный интервал реализован в виде копии конечной части символа OFDM, добавляемой в начало этого же символа (cyclic prefix).

### Алгоритм грубой временной синхронизации
Грубая временная синхронизация - это определение положения позиций защитных интервалов в нашем сигнале. Хорошо, если нам удастся найти точный старт защитного интервала у каждого символа(а зачастую при наличии различных искажений точное начало защитного интервала не гарантируется), но это необязательно, достаточно лишь знать какой-либо отсчёт принадлежащий защитному интервалу для каждого символа.

По сути, алгоритм грубой частотной синхронизации - это взятие автокорреляционной функции (ACF) от сигнала с окном, заданного размера в отсчётах. То есть мы производим корреляционный анализ нашего сигнала с целью найти позиции защитных интервалов. Расчёт ACF производится по формулам, которые можно видеть на рисунке №3.

![Alt-text](<graphs/form1.png>)

_Рисунок №5. Формула для расчёта автокорреляционной функции_
* $W$ - ширина окна усреднения (в отсчётах);
* Nfft - размер полезной части одного ofdm-символа (в отсчётах);
* $s_n$ - отсчёт под номером n отправленного сигнала.

Для расчёта ACF достаточно взять `2*Nfft` отсчётов и больше (на графиках ниже ACF была рассчитана для всего принятого сигнала, а потом приближен масштаб по оси x в целях лучшей наглядности), поскольку у нас происходит сдвиг именно на Nfft отсчётов по формуле на рисунке 5. Рассмотрим различную ширину скользящего среднего окна при расчёте ACF (различные значения W в формуле из рисунка №3):

![Alt-text](<graphs/W1.png>)

_Рисунок №6. ACF с W=1 отсчёту_

![Alt-text](<graphs/Wtguard2.png>)

_Рисунок №7. ACF с W=T_Guard/2 отсчётов_

![Alt-text](<graphs/Wtg.png>)

_Рисунок №8. ACF с W=T_Guard отсчётов_

![Alt-text](<graphs/WNfft.png>)

_Рисунок №9. ACF с W=Nfft отсчётов_

Как можно видеть, размер окна _W_ существенно влияет на вид ACF: с увеличением ширины окна мы видим появление характерных пиков - позиции защитных интервалов. Эти пики сначала имеют плоские плато (рисунок 7), но с приближением значения _W_ в T_Guard отсчётов видим один пик (рисунок 8) - это точное положение начала защитного интервала ofdm-символа в идеальном случае (отсутствие искажений и идеальная точность вычислений). Если мы продолжим увеличивать _W_, то пики снижаются и постепенно вовсе пропадают (рисунок 9).

На мой взгляд, оптимальным значением _W_ является `T_Guard/2` отсчётов, потому что в этой ситуации (рисунок 7) мы имеем высокие пики с плато в единице, а это позволяет нам более надёжно рассчитать позицию защитного интервала, ведь если у нас будет только один пик (рисунок 8), то при наличии различных искажений в канале (частотная рассинхронизация, многолучевое распространение, АБГШ) определить позицию одного пика может быть отнюдь нетривиальной задачей. Напротив, когда же у нас плато, то вероятность его идентификации выше. К тому же, используя некоторое барьерное значение (Threshold), легко рассчитать положение защитного интервала. Тем не менее, при уменьшении $W$ значения АКФ вне плато/пика увеличиваются, что может привести к увеличению вероятности ложного срабатывания при пороговом поиске пиков. Поэтому важно найти некоторое компромиссное значение ширины окна усреднения. К примеру, $W = T_{Guard}/2$.

При значении _W_=T_Guard/2 середина защитного интервала точно будет расположена в последнем отсчёте из нашего "единичного" плато. Примерно его можно оценить с помощью Threshold (смотреть рисунок 10).

![Alt-text](<graphs/tg2.png>)

_Рисунок №10. Примерная позиция середины T_Guard_

## Частотная синхронизация

Для осуществления частотной синхронизации снова используется корреляционный анализ. Рассмотрим уже знакомые нам формулы (рисунок 5), но теперь добавим частотный сдвиг:

![Alt-text](<graphs/form2.png>)

_Рисунок №11. Формула для оценки частотного сдвига по ACF_
* $r_n$ - отсчёт под номером n принятого сигнала.

Видно, что нужно оценить фазу ACF. Но нам необходимо оценить эту фазу в правильных позициях - в позициях защитного интервала. Т.е. после того, как мы нашли позиции защитных интервалов, нам остаётся оценить частотный сдвиг по формуле на рисунке 12.

![Alt-text](<graphs/form3.png>)

_Рисунок №12. Формула для расчёта частотного сдвига по ACF_

Проблема частотной рассинхронизации заключается в том, что она может быть дробной (не кратной $\frac{1}{Nfft}$) и целочисленной (кратной $\frac{1}{Nfft}$ - расстоянию между поднесущими). И способ описанный выше позволяет компенсировать только дробную частотную рассинхронизацию. Для компенсации целочисленной частотной рассинхронизации необходимо в спектре сигнала оценить частотный сдвиг, введя некоторое барьерное значение (Treshold).

Стоит также отметить, что при наличии АБГШ (до SNR = 10 dB) в канале данный метод частотной синхронизации даёт довольно ощутимый сбой - это можно наблюдать на рисунках 13а, 13б.

![Alt-text](<graphs/noise_ffo.png>)

_Рисунок №13а. Влияние шума на оценку дробного частотного сдвига_

![Alt-text](<graphs/noise_ifo.png>)

_Рисунок №13б. Влияние шума на оценку целочисленного частотного сдвига_

При низких SNR ошибка большая, что говорит о том, что наш алгоритм корреляционной оценки позиции не справляется. Значит, при значениях SNR примерно ниже `10 dB` данный метод не годится. Но выше `10 dB` всё отрабатывает практически без ошибки. Стало быть, при низких значениях SNR следует использовать более устойчивые к шуму методы оценки частотного сдвига.

## Тонкая временная синхронизация
Задача тонкой временной синхронизации – оценить временную задержку сигнала 
внутри одного OFDM символа (насколько грубая временная синхронизация далека от 
первого отсчёта полезной части OFDM символа).

![Alt-text](<graphs/phaseoffset.png>)

_Рисунок №14. Закрученное созвездие из-за фазового сдвига_

Временная задержка в пределах одного OFDM символа проявляется в виде закрученного созвездия (рисунок 14), поскольку фазовый сдвиг свой для каждой поднесущей. То есть из-за того, что у нас многочастотная система (или многоканальная, где в данном случае отдельный канал - это отдельная поднесущая) у нас будет прямопропорциональная  зависимость полной фазы спектра от номера поднесущей и величины этой задержки, то есть phase = k * phi, где phi - временная задержка.

Процесс тонкой временной синхронизации описан на рисунке 15.

![Alt-text](<graphs/finetime.png>)

_Рисунок №15. Алгоритм тонкой временной синхронизации_

По рисункам 16, 17 можно оценить влияние шума на тонкую временную синхронизацию. Моделирование производилось только при наличии АБГШ и временной рассинхронизации, остальные искажения отсутствовали. Что-то напоминающее созвездие появляется при `SNR = 12 dB`.

![Alt-text](<graphs/Влияние шума на тонкую временную синхронизацию.gif>)

_Рисунок №16. Созвездия при различном уровне шума в условиях временной рассинхронизации_

![Alt-text](<graphs/mer_snr.png>)

_Рисунок №17. |MER-SNR| для различного уровня шума в целях оценки его влияния на тонкую временную рассинхронизацию_

С увеличением пилотов оценка будет уточняться, поскольку она получается путём усреднения по всем принятым пилотным значениям. Как можно видеть на рисунках 18а, 18б с появлением шума оценка $\tau$ требует усреднения по всем пилотным значениям, поэтому в работе $\tau$ усредняется по всем принятым пилотным значениям, за исключением тех, где наблюдается резкий скачок (например, 400 отсчёт на графике 18а).

![Alt-text](<graphs/taus.png>)

_Рисунок №18а. График $\tau$ от номера поднесущей при наличии только временной рассинхронизации в канале_

![Alt-text](<graphs/taus_snr25.png>)

_Рисунок №18б. График $\tau$ от номера поднесущей при наличии АБГШ и временной рассинхронизации в канале_

## Эквализация
### Влияние многолучевого распространения на сигнал
Как можно видеть на рисунках 19, 20 ниже многолучевое распротранение проявляет себя в сигнале так, что он его АЧХ становится частотно-селективной. 

 ![Alt-text](<graphs/mp_sig.png>)

_Рисунок №19. АЧХ при многолучевом распространении_

 ![Alt-text](<graphs/sc_mp.png>)

 _Рисунок №20. Сигнальное созвездие при многолучевом распространении_

### Процедура оценки канальной характеристики
 Оценка канальной характеристики происходит с помощью пилотных поднесущих. Зная пилотные значения, мы получаем информацию о том, как их изменил канал. Далее мы интерполируем эту информацию, чтоб получить знание о канальных изменениях на поднесущих, соответствующих данным. И после этого мы получаем оценку канальной характеристики на интересующей нас полосе. Теперь мы можем разделить принятый сигнал на эту оценку и получить восстановленный сигнал - произвести эквализацию - т.е. скомпенсировать влияние канала на наш сигнал.

 ![Alt-text](<graphs/equalizing.png>)

 _Рисунок №21. Эквализация_

 Интерполяцию можно производить по разным законам: линейному, кубическому, сплайновому. В таблице ниже представлен расчет MER для каждого типа интерполяции.
 
 |Интерполяция | Линейная | Кубическая | Сплайновая |
 |:----------:|:----------:|:----------:|:----------:|
 | MER, dB    | `60`   | `108`   |`130` |

 Отсюда можно сделать вывод, что сплайновая интерполяция является лучшей. Как можно видеть на рисунке 21, мы имеем дело с частотно-селективным каналом, который имеет множество локальных максимумов и минимумов на графике АЧХ. График функции АЧХ является непрерывным и гладким, тогда и интерполировать нужно учитывая этот факт. Значит, сплайновая интерполяция будет иметь преимущество над другими, поскольку она учитывает это обстоятельство.

### Влияние шума на оценку канальной характеристики

На рисунке 22 приведён график усредненной СКО по всем отсчётам эффективной полосы сигнала. Как можно видеть, АБГШ перестаёт вносить сколь-нибудь ощутимый вклад при `SNR = 15 dB`. 

 ![Alt-text](<graphs/nmse(snr).png>)

 _Рисунок №22._ $NMSE = \frac{(H_{estimated}-H_{true})^2}{N_{carrier}}$

### Влияние различного количества пилотов на оценку канальной характеристики

 ![Alt-text](<graphs/nmse(snr)_step2.png>)

 _Рисунок №23. NMSE(SNR) при периоде пилотов = 2 отсчёта_ 

  ![Alt-text](<graphs/nmse(snr)_step50.png>)

 _Рисунок №24. NMSE(SNR) при периоде пилотов = 50 отсчётов_

 Как можно видеть на рисунках 23, 24 при малом количестве пилотов в присутсвии АБГШ в канале оценка характеристики этого канала не достигает желаемой точности, в то же самое время при большом количестве пилотов желаемая точность может быть достигнута при приемлемом (`SNR = 15 dB`) уровне шума. Таким образом, с увеличением количества пилотов, точность оценки канала тоже увеличивается.