# Отчет к домашнему заданию №4: Синхронизация. Компенсация канальных искажений

## Квинтэссенция работы
 В этой работе рассмотрены способы компенсации различных канальных искажений (АБГШ, временной рассинхронизации, частотной рассинхронизации и многолучевого распространения). Для этого были использованы такие инструменты, как корреляционный анализ, расчёт дифференциальных коэффициентов, оценка канальной характеристики и эквализация. В целях оценки канала в сигнал встраиваются пилоты. Схему построенной в этой работе системы можно видеть на рисунке №1.

![Alt-text](<graphs/task4.png>)
_Рисунок №1. Пайплайн OFDM-системы_

**Параметры OFDM передачи**
* Сигнальное созвездие: `16QAM`;
* Длительной полезной части в количестве fft отсчётов: `N_fft = 1024`
* Количество поднесущих в одном OFDM символе: `N_carrier = 400`
* Длина защитного интервала: `T_Guard = Nfft/8=128`
* Количество кадров: `Amount_OFDM_Frames = 10`
* Количество генерируемых OFDM символов: `Amount_OFDM_Symbols_per_Frame = 5`
* Количество пилотных поднесущих (процент от полосы):
`Percent_pilot = 15`
* Амплитуда пилотных значений:
`4/3*максимальная_амплитуда_созвездия`

## Пилот сигнал
Pilot Carriers - это поднесущие, которые содержат в себе известные значения для осуществления оценки канала и эквалайзинга на приемнике. Пилоты встраиваются в сигнал вместе с данными на этапе формирования полосы сигнала. Они обеспечивают контрольные точки для определения канальной характеристики и её компенсации.

В данной реализации амплитуда пилотов составляет $\frac{4}{3}$ от максимальной амплитуды созвездия. Фазы пилотов задаются чередованием фаз BPSK модуляции `(0, pi)`. Пилоты равномерно распределены по полосе, первая и последняя поднесущая тоже отнесены к пилотным.
## Грубая временная синхронизация
### Защитный интервал

![Alt-text](<graphs/GI.png>)
_Рисунок №2. Схема добавления защитного интервала по принципу циклического префикса_

Защитный интервал: это часть сигнала, входящая в состав OFDM-символа для сохранения 
возможности демодуляции OFDM-сигнала в присутствии многолучевых помех, таких как отражения 
сигнала и разные задержки лучей этого сигнала. Защитный интервал обеспечивает ортогональность 
между полезными частями символов, позволяя правильно разделять их в приемнике. То есть защитный интервал служит 
неким окном, в течение которого символы разных лучей могут интерферировать между собой, но уже 
в полезной части символа (на рисунке №2 - T_useful) гарантируется отсутствие этой интерференции. 
Второстепенное назначение защитного интервала заключается в том, что:
1. с его наличием становится возможным считать циклическую свёртку ofdm-символа.
2. его можно использовать в алгоритмах синхронизации для компенсации временной и частотной рассинхронизаций.

В данной работе защитный интервал реализован в виде копии конечной части символа OFDM, добавляемой в начало этого же символа (cyclic prefix).

### Алгоритм грубой временной синхронизации
Грубая временная синхронизация - это определение положения позиций защитных интервалов в нашем сигнале. Хорошо, если нам удастся найти точный старт защитного интервала у каждого символа, но это необязательно, достаточно лишь знать какой-либо отсчёт принадлежащий защитному интервалу для каждого символа.

По сути, алгоритм грубой частотной синхронизации - это взятие автокорреляционной функции (ACF) от сигнала с окном, заданного размера в отсчётах. То есть мы производим корреляционный анализ нашего сигнала с целью найти позиции защитных интервалов. Расчёт ACF производится по формулам, которые можно видеть на рисунке №3.

![Alt-text](<graphs/form1.png>)
_Рисунок №3. Формула для расчёта автокорреляционной функции_

Для расчёта ACF достаточно взять `2*Nfft` отсчётов и больше, поскольку у нас происходит сдвиг именно на Nfft отсчётов по формуле на рисунке 3. Рассмотрим различную ширину скользящего среднего окна при расчёте ACF (различные значения W в формуле из рисунка №3):

![Alt-text](<graphs/W1.png>)
_Рисунок №4. ACF с W=1 отсчёту_

![Alt-text](<graphs/Wtguard2.png>)
_Рисунок №5. ACF с W=T_Guard/2 отсчётов_

![Alt-text](<graphs/Wtg.png>)
_Рисунок №6. ACF с W=T_Guard отсчётов_

![Alt-text](<graphs/WNfft.png>)
_Рисунок №7. ACF с W=Nfft отсчётов_

Как можно видеть, размер окна _W_ существенно влияет на вид ACF: с увеличением ширины окна мы видим появление характерных пиков - позиции защитных интервалов. Эти пики сначала имеют плоские плато (рисунок 5), но с приближением значения _W_ в T_Guard отсчётов видим один пик (рисунок 6) - это точное положение начала защитного интервала ofdm-символа. Если мы продолжим увеличивать _W_, то пики снижаются и постепенно вовсе пропадают (рисунок 7).

На мой взгляд, оптимальным значением _W_ является `T_Guard/2` отсчётов, потому что в этой ситуации (рисунок 5) мы имеем высокие пики с плато в единице, а это позволяет нам более надёжно рассчитать позицию защитного интервала, ведь если у нас будет только один пик (рисунок 6), то при наличии различных искажений в канале (частотная рассинхронизация, многолучевое распространение, АБГШ) определить позицию одного пика может быть отнюдь нетривиальной задачей. Напротив, когда же у нас плато, то вероятность его идентификации выше. К тому же, используя некоторое барьерное значение (Threshold), легко рассчитать положение защитного интервала. 

При значении _W_=T_Guard/2 середина защитного интервала точно будет расположена в последнем отсчёте из нашего "единичного" плато. Примерно его можно оценить с помощью Threshold (смотреть рисунок 8).

![Alt-text](<graphs/tg2.png>)
_Рисунок №8. Примерная позиция середины T_Guard_

## Частотная синхронизация

Для осуществления частотной синхронизации снова используется корреляционный анализ. Рассмотрим уже знакомые нам формулы (рисунок 3), но теперь добавим частотный сдвиг:

![Alt-text](<graphs/form2.png>)
_Рисунок №9. Формула для оценки частотного сдвига по ACF_

Видно, что нужно оценить фазу ACF. Но нам необходимо оценить эту фазу в правильных позициях - в позициях защитного интервала. Т.е. после того, как мы нашли позиции защитных интервалов, нам остаётся оценить частотный сдвиг по формуле на рисунке 10.

![Alt-text](<graphs/form3.png>)
_Рисунок №10. Формула для расчёта частотного сдвига по ACF_

Проблема частотной рассинхронизации заключается в том, что она может быть дробной и целочисленной. И способ описанный выше позволяет компенсировать только дробную частотную рассинхронизацию. Для компенсации целочисленной частотной рассинхронизации необходимо в спектре сигнала оценить частотный сдвиг, введя некоторое барьерное значение (Treshold).

Стоит также отметить, что при наличии АБГШ в канале данный метод частотной синхронизации даёт довольно ощутимый сбой - это можно наблюдать на рисунке 11.

![Alt-text](<graphs/noise_cfo.png>)
_Рисунок №11. Влияние шума на оценку частотного сдвига_

При низких SNR ошибка большая, что говорит о том, что наш алгоритм корреляционной оценки позиции не справляется. Значит, при значениях SNR примерно ниже `10 dB` данный метод не годится. Но выше `10 dB` всё отрабатывает штатно. Стало быть, при низких значениях SNR следует использовать более устойчивые к шуму методы оценки частотного сдвига.

## Тонкая временная синхронизация
Задача тонкой временной синхронизации – оценить временную задержку сигнала 
внутри одного OFDM символа (насколько грубая временная синхронизация далека от 
первого отсчёта полезной части OFDM символа).

![Alt-text](<graphs/phaseoffset.png>)
_Рисунок №12. Закрученное созвездие из-за фазового сдвига_

Временная задержка в пределах одного OFDM символа проявляется в виде закрученного созвездия (рисунок 12), поскольку фазовый сдвиг свой для каждой поднесущей. То есть из-за того, что у нас многочастотная система (или многоканальная, где в данном случае отдельный канал - это отдельная поднесущая) у нас будет прямопропорциональная  зависимость полной фазы спектра от номера поднесущей и величины этой задержки, то есть phase = k * phi, где phi - временная задержка.

Процесс тонкой временной синхронизации описан на рисунке 13.

![Alt-text](<graphs/finetime.png>)
_Рисунок №13. Алгоритм тонкой временной синхронизации_

__P.s. здесь должен быть раздел исследующий влияние шума на тонкую временную синхронизацию, но что-то я не сообразил, какой график можно здесь построить, учитывая, что значение фазового сдвига заранее мы не знаем и не задаём__

С увеличением пилотов оценка будет уточняться, поскольку она получается путём усреднения по всем принятым пилотным значениям.

## Эквализация
Как можно видеть на рисунках 14, 15 ниже многолучевое распротранение проявляет себя в сигнале так, что он его АЧХ становится частотно-селективной. 

 ![Alt-text](<graphs/mp_sig.png>)
_Рисунок №14. АЧХ при многолучевом распространении_

 ![Alt-text](<graphs/sc_mp.png>)
 _Рисунок №15. Сигнальное созвездие при многолучевом распространении_

 